<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimizador de Ahorros Avanzado</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
            min-height: 100vh;
            margin: 0;
            padding: 2rem;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1, h2, h3 {
            color: #1e3a8a;
        }

        h1 {
            font-size: 2.5rem;
            text-align: center;
            padding: 2rem;
            background: linear-gradient(to right, #3b82f6, #6366f1);
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .form-section, .results-section {
            padding: 2rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4b5563;
        }

        button {
            background: #3b82f6;
            color: white;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        button:hover {
            background: #2563eb;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .metric-card {
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1e40af;
        }

        .suggestion-card {
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .chart-container {
            height: 300px;
        }

        .hidden {
            display: none;
        }

        .priority-high {
            border-color: #ef4444 !important;
            background: #fee2e2 !important;
        }

        .priority-medium {
            border-color: #eab308 !important;
            background: #fef9c3 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><span>üîç</span> Optimizador de Ahorros Avanzado</h1>
        
        <div id="form-section" class="form-section">
            <div class="grid">
                <!-- Informaci√≥n Personal -->
                <div>
                    <h2>Informaci√≥n Personal</h2>
                    <div>
                        <label>Total de Ahorros (‚Ç¨)</label>
                        <input type="number" id="totalSavings" placeholder="50000">
                    </div>
                    <div>
                        <label>Edad</label>
                        <input type="number" id="age" placeholder="35">
                    </div>
                    <div>
                        <label>Tolerancia al Riesgo</label>
                        <select id="riskTolerance">
                            <option value="conservative">Conservador</option>
                            <option value="medium" selected>Moderado</option>
                            <option value="aggressive">Agresivo</option>
                        </select>
                    </div>
                    <div>
                        <label>Horizonte Temporal</label>
                        <select id="timeHorizon">
                            <option value="1-3">1-3 a√±os</option>
                            <option value="3-5">3-5 a√±os</option>
                            <option value="5-10" selected>5-10 a√±os</option>
                            <option value="10-20">10-20 a√±os</option>
                            <option value="20+">M√°s de 20 a√±os</option>
                        </select>
                    </div>
                    <div>
                        <label>Inflaci√≥n Actual (%)</label>
                        <input type="number" step="0.1" id="currentInflation" value="3.5">
                    </div>
                    <div>
                        <label>Aportaci√≥n Mensual Total (‚Ç¨)</label>
                        <input type="number" id="monthlyContribution" placeholder="500">
                    </div>
                    <div>
                        <label>Gastos Mensuales (‚Ç¨) - Para Fondo de Emergencia</label>
                        <input type="number" id="monthlyExpenses" placeholder="2000">
                    </div>
                </div>

                <!-- Distribuci√≥n Actual -->
                <div>
                    <h2>Distribuci√≥n Actual de Ahorros</h2>
                    <div>
                        <label>Cuenta Corriente (‚Ç¨)</label>
                        <input type="number" id="cashAccount" placeholder="0">
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label>Cuenta Remunerada (‚Ç¨)</label>
                            <input type="number" id="savingsAccount" placeholder="0">
                        </div>
                        <div class="w-24">
                            <label>%</label>
                            <input type="number" step="0.1" id="savingsRate" value="0.5">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label>Fondo Monetario (‚Ç¨)</label>
                            <input type="number" id="moneyMarket" placeholder="0">
                        </div>
                        <div class="w-24">
                            <label>%</label>
                            <input type="number" step="0.1" id="moneyMarketRate" value="4.5">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label>Renta Fija/Bonos (‚Ç¨)</label>
                            <input type="number" id="bonds" placeholder="0">
                        </div>
                        <div class="w-24">
                            <label>%</label>
                            <input type="number" step="0.1" id="bondsRate" value="3.5">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label>Fondos Indexados (‚Ç¨)</label>
                            <input type="number" id="indexFunds" placeholder="0">
                        </div>
                        <div class="w-24">
                            <label>%</label>
                            <input type="number" step="0.1" id="indexFundsRate" value="8">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label>Renta Variable/Acciones (‚Ç¨)</label>
                            <input type="number" id="stocks" placeholder="0">
                        </div>
                        <div class="w-24">
                            <label>%</label>
                            <input type="number" step="0.1" id="stocksRate" value="10">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label>REITs/Inmobiliario (‚Ç¨)</label>
                            <input type="number" id="realEstate" placeholder="0">
                        </div>
                        <div class="w-24">
                            <label>%</label>
                            <input type="number" step="0.1" id="realEstateRate" value="6">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label>Criptomonedas (‚Ç¨)</label>
                            <input type="number" id="crypto" placeholder="0">
                        </div>
                        <div class="w-24">
                            <label>%</label>
                            <input type="number" step="0.1" id="cryptoRate" value="15">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label>Materias Primas (‚Ç¨)</label>
                            <input type="number" id="commodities" placeholder="0">
                        </div>
                        <div class="w-24">
                            <label>%</label>
                            <input type="number" step="0.1" id="commoditiesRate" value="5">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label>Otras Inversiones (‚Ç¨)</label>
                            <input type="number" id="other" placeholder="0">
                        </div>
                        <div class="w-24">
                            <label>%</label>
                            <input type="number" step="0.1" id="otherRate" value="5">
                        </div>
                    </div>
                </div>
            </div>

            <!-- DCA Section -->
            <div id="dca-section" class="mt-8 p-4 bg-blue-50 rounded-lg border border-blue-200 hidden">
                <h3>Distribuci√≥n DCA Mensual</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label>A Cuenta Corriente</label>
                        <input type="number" id="dcaCashAccount" placeholder="0">
                    </div>
                    <div>
                        <label>A Cuenta Remunerada</label>
                        <input type="number" id="dcaSavingsAccount" placeholder="0">
                    </div>
                    <div>
                        <label>A Fondo Monetario</label>
                        <input type="number" id="dcaMoneyMarket" placeholder="0">
                    </div>
                    <div>
                        <label>A Renta Fija</label>
                        <input type="number" id="dcaBonds" placeholder="0">
                    </div>
                    <div>
                        <label>A Fondos Indexados</label>
                        <input type="number" id="dcaIndexFunds" placeholder="0">
                    </div>
                    <div>
                        <label>A Renta Variable</label>
                        <input type="number" id="dcaStocks" placeholder="0">
                    </div>
                    <div>
                        <label>A REITs</label>
                        <input type="number" id="dcaRealEstate" placeholder="0">
                    </div>
                    <div>
                        <label>A Criptomonedas</label>
                        <input type="number" id="dcaCrypto" placeholder="0">
                    </div>
                    <div>
                        <label>A Materias Primas</label>
                        <input type="number" id="dcaCommodities" placeholder="0">
                    </div>
                    <div>
                        <label>A Otros</label>
                        <input type="number" id="dcaOther" placeholder="0">
                    </div>
                </div>
                <p id="total-dca" class="mt-2 text-sm text-blue-600"></p>
            </div>

            <button onclick="calculateAnalysis()" class="w-full mt-6">Analizar Optimizaci√≥n</button>
        </div>

        <div id="results-section" class="results-section hidden">
            <div id="score-card" class="card metric-card"></div>
            <div class="grid">
                <div class="card metric-card" id="current-return"></div>
                <div class="card metric-card" id="potential-return"></div>
                <div class="card metric-card" id="potential-diff"></div>
                <div class="card metric-card" id="with-dca"></div>
            </div>
            <div class="grid">
                <div class="card">
                    <h3>Distribuci√≥n Actual</h3>
                    <div class="chart-container"><canvas id="pie-chart"></canvas></div>
                </div>
                <div class="card">
                    <h3>Proyecci√≥n Futura</h3>
                    <div id="projections-list"></div>
                </div>
            </div>
            <div class="card" id="rebalance-plan"></div>
            <div class="card" id="dca-recommended"></div>
            <div class="card" id="creative-suggestions"></div>
            <div class="card" id="recommended-distribution"></div>
            <button onclick="resetForm()" class="w-full">Nuevo An√°lisis</button>
        </div>
    </div>

    <script>
        let analysis = null;
        const COLORS = ['#3b82f6', '#6366f1', '#a855f7', '#ec4899', '#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#06b6d4'];

        function getFormData() {
            return {
                totalSavings: document.getElementById('totalSavings').value,
                age: document.getElementById('age').value,
                riskTolerance: document.getElementById('riskTolerance').value,
                timeHorizon: document.getElementById('timeHorizon').value,
                currentInflation: document.getElementById('currentInflation').value,
                monthlyContribution: document.getElementById('monthlyContribution').value,
                monthlyExpenses: document.getElementById('monthlyExpenses').value,
                cashAccount: document.getElementById('cashAccount').value,
                savingsAccount: document.getElementById('savingsAccount').value,
                savingsRate: document.getElementById('savingsRate').value,
                moneyMarket: document.getElementById('moneyMarket').value,
                moneyMarketRate: document.getElementById('moneyMarketRate').value,
                bonds: document.getElementById('bonds').value,
                bondsRate: document.getElementById('bondsRate').value,
                indexFunds: document.getElementById('indexFunds').value,
                indexFundsRate: document.getElementById('indexFundsRate').value,
                stocks: document.getElementById('stocks').value,
                stocksRate: document.getElementById('stocksRate').value,
                realEstate: document.getElementById('realEstate').value,
                realEstateRate: document.getElementById('realEstateRate').value,
                crypto: document.getElementById('crypto').value,
                cryptoRate: document.getElementById('cryptoRate').value,
                commodities: document.getElementById('commodities').value,
                commoditiesRate: document.getElementById('commoditiesRate').value,
                other: document.getElementById('other').value,
                otherRate: document.getElementById('otherRate').value,
                dcaCashAccount: document.getElementById('dcaCashAccount').value,
                dcaSavingsAccount: document.getElementById('dcaSavingsAccount').value,
                dcaMoneyMarket: document.getElementById('dcaMoneyMarket').value,
                dcaBonds: document.getElementById('dcaBonds').value,
                dcaIndexFunds: document.getElementById('dcaIndexFunds').value,
                dcaStocks: document.getElementById('dcaStocks').value,
                dcaRealEstate: document.getElementById('dcaRealEstate').value,
                dcaCrypto: document.getElementById('dcaCrypto').value,
                dcaCommodities: document.getElementById('dcaCommodities').value,
                dcaOther: document.getElementById('dcaOther').value,
                includeRealEstate: true, // Fixed preferences for simplicity
                includeCrypto: false,
                includeCommodities: true,
                includeInternational: true,
                includeTechStocks: true,
                sustainableInvesting: false
            };
        }

        function calculateAnalysis() {
            const formData = getFormData();
            const total = parseFloat(formData.totalSavings) || 0;
            if (total === 0) return;

            const inflation = parseFloat(formData.currentInflation) || 3.5;
            const monthlyContribution = parseFloat(formData.monthlyContribution) || 0;
            const monthlyExpenses = parseFloat(formData.monthlyExpenses) || 0;

            const distribution = {
                cashAccount: parseFloat(formData.cashAccount) || 0,
                savingsAccount: parseFloat(formData.savingsAccount) || 0,
                moneyMarket: parseFloat(formData.moneyMarket) || 0,
                bonds: parseFloat(formData.bonds) || 0,
                indexFunds: parseFloat(formData.indexFunds) || 0,
                stocks: parseFloat(formData.stocks) || 0,
                realEstate: parseFloat(formData.realEstate) || 0,
                crypto: parseFloat(formData.crypto) || 0,
                commodities: parseFloat(formData.commodities) || 0,
                other: parseFloat(formData.other) || 0
            };

            const dcaDistribution = {
                cashAccount: parseFloat(formData.dcaCashAccount) || 0,
                savingsAccount: parseFloat(formData.dcaSavingsAccount) || 0,
                moneyMarket: parseFloat(formData.dcaMoneyMarket) || 0,
                bonds: parseFloat(formData.dcaBonds) || 0,
                indexFunds: parseFloat(formData.dcaIndexFunds) || 0,
                stocks: parseFloat(formData.dcaStocks) || 0,
                realEstate: parseFloat(formData.dcaRealEstate) || 0,
                crypto: parseFloat(formData.dcaCrypto) || 0,
                commodities: parseFloat(formData.dcaCommodities) || 0,
                other: parseFloat(formData.dcaOther) || 0
            };

            const totalAllocated = Object.values(distribution).reduce((sum, val) => sum + val, 0);
            const totalDCA = Object.values(dcaDistribution).reduce((sum, val) => sum + val, 0);

            const weightedReturn = (
                (distribution.cashAccount * 0) +
                (distribution.savingsAccount * parseFloat(formData.savingsRate)) +
                (distribution.moneyMarket * parseFloat(formData.moneyMarketRate)) +
                (distribution.bonds * parseFloat(formData.bondsRate)) +
                (distribution.indexFunds * parseFloat(formData.indexFundsRate)) +
                (distribution.stocks * parseFloat(formData.stocksRate)) +
                (distribution.realEstate * parseFloat(formData.realEstateRate)) +
                (distribution.crypto * parseFloat(formData.cryptoRate)) +
                (distribution.commodities * parseFloat(formData.commoditiesRate)) +
                (distribution.other * parseFloat(formData.otherRate))
            ) / totalAllocated;

            // Fondo de Emergencia
            let monthsFactor;
            if (formData.riskTolerance === 'conservative') monthsFactor = 9;
            else if (formData.riskTolerance === 'medium') monthsFactor = 6;
            else monthsFactor = 4;
            const requiredEmergency = monthlyExpenses * monthsFactor;
            const currentLiquid = distribution.cashAccount + distribution.savingsAccount + distribution.moneyMarket;

            const getRecommendedAllocation = () => {
                const age = parseInt(formData.age) || 30;
                const riskTolerance = formData.riskTolerance;
                let recommendations = {};

                if (riskTolerance === 'conservative') {
                    recommendations = {
                        cashAccount: Math.max(3, Math.min(15, 120 - age)),
                        savingsAccount: 15,
                        moneyMarket: 20,
                        bonds: 40,
                        indexFunds: 15,
                        stocks: 5,
                        realEstate: 0,
                        crypto: 0,
                        commodities: 0,
                        other: 0
                    };
                } else if (riskTolerance === 'aggressive') {
                    recommendations = {
                        cashAccount: 5,
                        savingsAccount: 5,
                        moneyMarket: 5,
                        bonds: 10,
                        indexFunds: 40,
                        stocks: 25,
                        realEstate: formData.includeRealEstate ? 5 : 0,
                        crypto: formData.includeCrypto ? 3 : 0,
                        commodities: formData.includeCommodities ? 2 : 0,
                        other: 0
                    };
                } else {
                    recommendations = {
                        cashAccount: Math.max(5, Math.min(10, 110 - age)),
                        savingsAccount: 10,
                        moneyMarket: 10,
                        bonds: 25,
                        indexFunds: 35,
                        stocks: 10,
                        realEstate: formData.includeRealEstate ? 3 : 0,
                        crypto: formData.includeCrypto ? 1 : 0,
                        commodities: formData.includeCommodities ? 1 : 0,
                        other: 0
                    };
                }

                // Ajustar por exclusiones
                const excludedTotal = 
                    (!formData.includeRealEstate ? recommendations.realEstate : 0) +
                    (!formData.includeCrypto ? recommendations.crypto : 0) +
                    (!formData.includeCommodities ? recommendations.commodities : 0);
                if (excludedTotal > 0) {
                    recommendations.indexFunds += excludedTotal * 0.7;
                    recommendations.bonds += excludedTotal * 0.3;
                    if (!formData.includeRealEstate) recommendations.realEstate = 0;
                    if (!formData.includeCrypto) recommendations.crypto = 0;
                    if (!formData.includeCommodities) recommendations.commodities = 0;
                }

                // Ajustar por Fondo de Emergencia
                const requiredLiquidPercent = Math.min(100, (requiredEmergency / totalAllocated) * 100);
                let currentRecLiquid = recommendations.cashAccount + recommendations.savingsAccount + recommendations.moneyMarket;
                if (requiredLiquidPercent > currentRecLiquid) {
                    const diff = requiredLiquidPercent - currentRecLiquid;
                    recommendations.moneyMarket += diff;
                    if (riskTolerance === 'aggressive') {
                        recommendations.stocks = Math.max(0, recommendations.stocks - diff);
                    } else {
                        recommendations.bonds = Math.max(0, recommendations.bonds - diff);
                    }
                }

                return recommendations;
            };

            const recommended = getRecommendedAllocation();

            const getRecommendedDCA = () => {
                const riskTolerance = formData.riskTolerance;
                let dcaRec = {};
                let excludedTotal = 0;

                if (riskTolerance === 'conservative') {
                    dcaRec = {
                        cashAccount: 0,
                        savingsAccount: 20,
                        moneyMarket: 30,
                        bonds: 40,
                        indexFunds: 10,
                        stocks: 0,
                        realEstate: 0,
                        crypto: 0,
                        commodities: 0,
                        other: 0
                    };
                } else if (riskTolerance === 'aggressive') {
                    dcaRec = {
                        cashAccount: 0,
                        savingsAccount: 5,
                        moneyMarket: 5,
                        bonds: 5,
                        indexFunds: 50,
                        stocks: 25,
                        realEstate: formData.includeRealEstate ? 5 : 0,
                        crypto: formData.includeCrypto ? 3 : 0,
                        commodities: formData.includeCommodities ? 2 : 0,
                        other: 0
                    };
                    excludedTotal = 
                        (!formData.includeRealEstate ? 5 : 0) +
                        (!formData.includeCrypto ? 3 : 0) +
                        (!formData.includeCommodities ? 2 : 0);
                    if (excludedTotal > 0) {
                        dcaRec.indexFunds += excludedTotal * 0.8;
                        dcaRec.stocks += excludedTotal * 0.2;
                    }
                } else {
                    dcaRec = {
                        cashAccount: 0,
                        savingsAccount: 10,
                        moneyMarket: 10,
                        bonds: 15,
                        indexFunds: 50,
                        stocks: 10,
                        realEstate: formData.includeRealEstate ? 3 : 0,
                        crypto: formData.includeCrypto ? 1 : 0,
                        commodities: formData.includeCommodities ? 1 : 0,
                        other: 0
                    };
                    excludedTotal = 
                        (!formData.includeRealEstate ? 3 : 0) +
                        (!formData.includeCrypto ? 1 : 0) +
                        (!formData.includeCommodities ? 1 : 0);
                    if (excludedTotal > 0) {
                        dcaRec.indexFunds += excludedTotal * 0.7;
                        dcaRec.bonds += excludedTotal * 0.3;
                    }
                }
                return dcaRec;
            };

            const recommendedDCA = getRecommendedDCA();

            const potentialReturn = (
                (recommended.cashAccount * 0) +
                (recommended.savingsAccount * parseFloat(formData.savingsRate)) +
                (recommended.moneyMarket * parseFloat(formData.moneyMarketRate)) +
                (recommended.bonds * parseFloat(formData.bondsRate)) +
                (recommended.indexFunds * parseFloat(formData.indexFundsRate)) +
                (recommended.stocks * parseFloat(formData.stocksRate)) +
                (recommended.realEstate * parseFloat(formData.realEstateRate)) +
                (recommended.crypto * parseFloat(formData.cryptoRate)) +
                (recommended.commodities * parseFloat(formData.commoditiesRate)) +
                (recommended.other * parseFloat(formData.otherRate))
            ) / 100;

            const calculateScore = () => {
                let score = 100;
                const cashPercent = (distribution.cashAccount / totalAllocated) * 100;
                if (cashPercent > 20) score -= (cashPercent - 20) * 2;

                const nonZeroAssets = Object.values(distribution).filter(val => val > 0).length;
                if (nonZeroAssets < 3) score -= 20;

                const realReturn = weightedReturn - inflation;
                if (realReturn > 0) score += Math.min(20, realReturn * 3);
                else score -= Math.abs(realReturn) * 5;

                if (formData.riskTolerance === 'conservative' && weightedReturn > 6) score -= 10;
                if (formData.riskTolerance === 'aggressive' && weightedReturn < 7) score -= 15;

                if (monthlyContribution > 0) score += 10;
                if (totalDCA === monthlyContribution) score += 5;

                // Penalizar fondo de emergencia insuficiente
                if (currentLiquid < requiredEmergency) score -= 20 * (1 - currentLiquid / requiredEmergency);

                return Math.max(0, Math.min(100, score));
            };

            const optimizationScore = calculateScore();

            const projectionYears = parseInt(formData.timeHorizon.split('-')[1]) || 10;
            const currentProjection = total * Math.pow(1 + weightedReturn/100, projectionYears);
            const optimizedProjection = total * Math.pow(1 + potentialReturn/100, projectionYears);
            const inflationAdjustedCurrent = total * Math.pow(1 + inflation/100, projectionYears);
            const dcaProjection = monthlyContribution > 0 ? 
                monthlyContribution * 12 * (Math.pow(1 + potentialReturn/100, projectionYears) - 1) / (potentialReturn/100) : 0;

            const generateRebalanceRecommendations = () => {
                const recommendations = [];
                Object.keys(distribution).forEach(asset => {
                    const current = (distribution[asset] / totalAllocated) * 100;
                    const target = recommended[asset];
                    const difference = current - target;
                    if (Math.abs(difference) > 2) {
                        recommendations.push({
                            type: difference > 0 ? 'reduce' : 'increase',
                            asset: getAssetName(asset),
                            current: current.toFixed(1),
                            target: target.toFixed(1),
                            amount: formatCurrency(Math.abs(difference / 100) * totalAllocated),
                            priority: Math.abs(difference) > 10 ? 'high' : 'medium'
                        });
                    }
                });
                return recommendations.sort((a, b) => (b.priority === 'high' ? 1 : 0) - (a.priority === 'high' ? 1 : 0));
            };

            const generateCreativeSuggestions = () => {
                const suggestions = [];
                const age = parseInt(formData.age) || 30;
                const riskTolerance = formData.riskTolerance;

                // Fondo de Emergencia siempre
                if (monthlyExpenses > 0 && currentLiquid < requiredEmergency) {
                    suggestions.push({
                        icon: 'üÜò',
                        title: 'Fondo de Emergencia Insuficiente',
                        description: `Necesitas al menos ${monthsFactor} meses de gastos (${formatCurrency(requiredEmergency)}) en activos l√≠quidos (cuenta corriente, remunerada o fondo monetario) con al menos 2% de rendimiento.`,
                        action: `Aumenta liquidez en ${formatCurrency(requiredEmergency - currentLiquid)}`,
                        category: 'seguridad'
                    });
                } else if (monthlyExpenses === 0) {
                    suggestions.push({
                        icon: '‚ö†Ô∏è',
                        title: 'Ingresa Gastos Mensuales',
                        description: 'Para calcular tu fondo de emergencia, ingresa tus gastos mensuales promedio.',
                        action: 'Actualiza el formulario',
                        category: 'urgente'
                    });
                }

                // Otras sugerencias (similar al original, abreviado por espacio)
                if (age < 35 && riskTolerance !== 'conservative') {
                    suggestions.push({
                        icon: 'üöÄ',
                        title: 'Aprovecha tu juventud',
                        description: 'Tienes tiempo para asumir m√°s riesgo.',
                        action: 'Sube indexados al 40-50%',
                        category: 'riesgo'
                    });
                }
                // Agregar m√°s si es necesario...

                return suggestions.slice(0, 8);
            };

            analysis = {
                distribution,
                dcaDistribution,
                totalAllocated,
                totalDCA,
                monthlyContribution,
                weightedReturn,
                potentialReturn,
                optimizationScore,
                recommended,
                recommendedDCA,
                projections: {
                    current: currentProjection,
                    optimized: optimizedProjection,
                    inflationAdjusted: inflationAdjustedCurrent,
                    withDCA: optimizedProjection + dcaProjection,
                    years: projectionYears
                },
                realReturn: weightedReturn - inflation,
                potentialRealReturn: potentialReturn - inflation,
                rebalanceRecommendations: generateRebalanceRecommendations(),
                creativeSuggestions: generateCreativeSuggestions(),
                requiredEmergency,
                currentLiquid
            };

            showResults();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(amount);
        }

        function formatPercentage(value) {
            return `${value.toFixed(2)}%`;
        }

        function getAssetName(key) {
            const names = {
                cashAccount: 'Cuenta Corriente',
                savingsAccount: 'Cuenta Remunerada',
                moneyMarket: 'Fondo Monetario',
                bonds: 'Renta Fija',
                indexFunds: 'Fondos Indexados',
                stocks: 'Renta Variable',
                realEstate: 'Inmobiliario',
                crypto: 'Criptomonedas',
                commodities: 'Materias Primas',
                other: 'Otros'
            };
            return names[key] || key;
        }

        function showResults() {
            document.getElementById('form-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');

            // Score
            document.getElementById('score-card').innerHTML = `
                <h3>Puntuaci√≥n de Optimizaci√≥n</h3>
                <div class="metric-value">${analysis.optimizationScore.toFixed(0)} / 100</div>
            `;

            // Metrics
            document.getElementById('current-return').innerHTML = `
                <h3>Rendimiento Actual</h3>
                <div class="metric-value">${formatPercentage(analysis.weightedReturn)}</div>
                <p>Real: ${formatPercentage(analysis.realReturn)}</p>
            `;
            document.getElementById('potential-return').innerHTML = `
                <h3>Potencial Optimizado</h3>
                <div class="metric-value">${formatPercentage(analysis.potentialReturn)}</div>
                <p>Real: ${formatPercentage(analysis.potentialRealReturn)}</p>
            `;
            document.getElementById('potential-diff').innerHTML = `
                <h3>Diferencia Potencial</h3>
                <div class="metric-value">${formatCurrency(analysis.projections.optimized - analysis.projections.current)}</div>
                <p>En ${analysis.projections.years} a√±os</p>
            `;
            document.getElementById('with-dca').innerHTML = `
                <h3>Con DCA</h3>
                <div class="metric-value">${formatCurrency(analysis.projections.withDCA)}</div>
                <p>Total proyectado</p>
            `;

            // Pie Chart
            const pieData = Object.entries(analysis.distribution).filter(([, v]) => v > 0).map(([k, v]) => ({
                label: getAssetName(k),
                value: v
            }));
            new Chart(document.getElementById('pie-chart'), {
                type: 'pie',
                data: {
                    labels: pieData.map(d => d.label),
                    datasets: [{ data: pieData.map(d => d.value), backgroundColor: COLORS }]
                },
                options: { responsive: true }
            });

            // Projections
            const projectionsList = document.getElementById('projections-list');
            projectionsList.innerHTML = `
                <p>Actual: ${formatCurrency(analysis.projections.current)}</p>
                <p>Optimizado: ${formatCurrency(analysis.projections.optimized)}</p>
                <p>Con DCA: ${formatCurrency(analysis.projections.withDCA)}</p>
                <p>Ajustado Inflaci√≥n: ${formatCurrency(analysis.projections.inflationAdjusted)}</p>
            `;

            // Rebalance
            const rebalancePlan = document.getElementById('rebalance-plan');
            rebalancePlan.innerHTML = '<h3>Plan de Rebalanceado</h3>';
            analysis.rebalanceRecommendations.forEach(rec => {
                rebalancePlan.innerHTML += `
                    <div class="suggestion-card priority-${rec.priority}">
                        ${rec.type === 'reduce' ? 'Reducir' : 'Aumentar'} ${rec.asset}: ${rec.amount} (Actual: ${rec.current}% ‚Üí Target: ${rec.target}%)
                    </div>
                `;
            });

            // DCA Recommended
            const dcaRecommended = document.getElementById('dca-recommended');
            if (analysis.monthlyContribution > 0) {
                dcaRecommended.innerHTML = '<h3>DCA Recomendada</h3>';
                Object.entries(analysis.recommendedDCA).filter(([, v]) => v > 0).forEach(([k, v]) => {
                    dcaRecommended.innerHTML += `<p>${getAssetName(k)}: ${v}% (${formatCurrency((v / 100) * analysis.monthlyContribution)})</p>`;
                });
            } else {
                dcaRecommended.classList.add('hidden');
            }

            // Creative Suggestions
            const creativeSuggestions = document.getElementById('creative-suggestions');
            creativeSuggestions.innerHTML = '<h3>Sugerencias Inteligentes</h3>';
            analysis.creativeSuggestions.forEach(sug => {
                creativeSuggestions.innerHTML += `
                    <div class="suggestion-card">
                        <span>${sug.icon}</span> <strong>${sug.title}</strong><br>
                        ${sug.description}<br>
                        Acci√≥n: ${sug.action}
                    </div>
                `;
            });

            // Recommended Distribution
            const recommendedDist = document.getElementById('recommended-distribution');
            recommendedDist.innerHTML = '<h3>Distribuci√≥n Recomendada</h3>';
            Object.entries(analysis.recommended).filter(([, v]) => v > 0).forEach(([k, v]) => {
                recommendedDist.innerHTML += `<p>${getAssetName(k)}: ${v}%</p>`;
            });
        }

        function resetForm() {
            document.getElementById('form-section').classList.remove('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.querySelectorAll('input').forEach(inp => inp.value = '');
        }

        // Show/Hide DCA section
        document.getElementById('monthlyContribution').addEventListener('input', (e) => {
            const dcaSection = document.getElementById('dca-section');
            if (parseFloat(e.target.value) > 0) {
                dcaSection.classList.remove('hidden');
            } else {
                dcaSection.classList.add('hidden');
            }
        });

        // Update total DCA
        const dcaInputs = ['dcaCashAccount', 'dcaSavingsAccount', 'dcaMoneyMarket', 'dcaBonds', 'dcaIndexFunds', 'dcaStocks', 'dcaRealEstate', 'dcaCrypto', 'dcaCommodities', 'dcaOther'];
        dcaInputs.forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                const total = dcaInputs.reduce((sum, id) => sum + (parseFloat(document.getElementById(id).value) || 0), 0);
                document.getElementById('total-dca').textContent = `Total DCA: ‚Ç¨${total}`;
            });
        });
    </script>
</body>
</html>
